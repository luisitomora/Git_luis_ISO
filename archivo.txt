#!/bin/bash

#############################################
# FICHERO DE ENTRADA
#############################################

FICHERO="$1"

if [[ -z "$FICHERO" ]]; then
    echo "Uso: $0 fichero_usuarios"
    exit 1
fi

if [[ ! -f "$FICHERO" ]]; then
    echo "ERROR: El fichero $FICHERO no existe."
    exit 1
fi

#############################################
# ARRAYS
#############################################

declare -A indice_usuario
declare -a usuarios

#############################################
# CARGAR FICHERO EN EL ARRAY
#############################################

cargar_fichero() {
    local i=0

    while IFS=":" read -r nombre uid home shell; do
        [[ -z "$nombre" ]] && continue
        usuarios[$i]="$nombre:$uid:$home:$shell"
        indice_usuario["$nombre"]=$i
        ((i++))
    done < "$FICHERO"
}

#############################################
# MOSTRAR USUARIO
#############################################

mostrar_usuario() {
    read -p "Nombre del usuario: " nombre

    if [[ -z "${indice_usuario[$nombre]}" ]]; then
        echo "El usuario no existe."
        return
    fi

    index=${indice_usuario[$nombre]}
    IFS=":" read n u h s <<< "${usuarios[$index]}"

    echo "----------------------------"
    echo "Nombre : $n"
    echo "UID    : $u"
    echo "Home   : $h"
    echo "Shell  : $s"
    echo "----------------------------"
}

#############################################
# CREAR USUARIO
#############################################

crear_usuario() {
    read -p "Nuevo nombre: " nombre

    if [[ -n "${indice_usuario[$nombre]}" ]]; then
        echo "Ya existe en la estructura."
        return
    fi

    read -p "UID: " uid
    read -p "Home: " home
    read -p "Shell: " shell

    index=${#usuarios[@]}
    usuarios[$index]="$nombre:$uid:$home:$shell"
    indice_usuario["$nombre"]=$index

    echo "Usuario creado en la estructura."
}

#############################################
# MODIFICAR USUARIO
#############################################

modificar_usuario() {
    read -p "Nombre usuario: " nombre

    [[ -z "${indice_usuario[$nombre]}" ]] && {
        echo "El usuario no existe."; return;
    }

    index=${indice_usuario[$nombre]}
    IFS=":" read n u h s <<< "${usuarios[$index]}"

    read -p "Nuevo UID ($u): " nuevo_uid
    read -p "Nuevo HOME ($h): " nuevo_home
    read -p "Nuevo SHELL ($s): " nuevo_shell

    usuarios[$index]="$nombre:${nuevo_uid:-$u}:${nuevo_home:-$h}:${nuevo_shell:-$s}"

    echo "Usuario modificado."
}

#############################################
# BORRAR USUARIO
#############################################

borrar_usuario() {
    read -p "Usuario a borrar: " nombre

    if [[ -z "${indice_usuario[$nombre]}" ]]; then
        echo "No existe."
        return
    fi

    index=${indice_usuario[$nombre]}

    unset 'usuarios[$index]'
    unset 'indice_usuario[$nombre]'

    echo "Usuario borrado."
}

#############################################
# VOLCAR SOLO NUEVOS USUARIOS A /etc/passwd
#############################################

volcar_sistema() {
    echo "Creando únicamente usuarios nuevos..."

    for linea in "${usuarios[@]}"; do
        [[ -z "$linea" ]] && continue

        IFS=":" read nombre uid home shell <<< "$linea"

        if id "$nombre" &>/dev/null; then
            echo "$nombre ya existe, no se crea."
            continue
        fi

        sudo useradd -u "$uid" -d "$home" -s "$shell" "$nombre"
        echo "Creado usuario en el sistema: $nombre"
    done
}

#############################################
# MOSTRAR MENÚ (FUNCIÓN)
#############################################

mostrar_menu() {
    echo ""
    echo "======== MENÚ PRINCIPAL ========"
    echo "1) Ver usuario"
    echo "2) Crear usuario"
    echo "3) Modificar usuario"
    echo "4) Borrar usuario"
    echo "5) Volcar al sistema (/etc/passwd)"
    echo "6) Salir"
    echo "7) Limpiar pantalla y mostrar menú"
    echo "================================"
}

#############################################
# INICIO
#############################################

cargar_fichero
mostrar_menu   # ⚡ SOLO SE MUESTRA UNA VEZ

while true; do
    read -p "Opción: " op

    case $op in
        1) mostrar_usuario ;;
        2) crear_usuario ;;
        3) modificar_usuario ;;
        4) borrar_usuario ;;
        5) volcar_sistema ;;
        6) exit ;;
        7) clear ; mostrar_menu ;;   # ⚡ LIMPIAR + MOSTRAR MENÚ
        *) echo "Opción no válida" ;;
    esac
done
